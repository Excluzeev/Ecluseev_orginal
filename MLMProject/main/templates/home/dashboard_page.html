{% extends 'layout.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid">
    <nav class="navbar navbar-expand-md navbar-block">
          <!-- Brand -->
          <a class="navbar-brand mlm-text-color" href="#">Formula 50</a>

          <!-- Toggler/collapsibe Button -->
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"><i class="fa fa-bars"></i> </span>
          </button>

          <!-- Navbar links -->
          <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">


                    <!--
                 <li class="nav-item">
                <a data-toggle="modal" data-target="#profile_modal" class="nav-link mlm-text-color" href="#"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;My Profile</a>
              </li>
                -->
              <li class="nav-item">
                <a class="nav-link mlm-text-color" href="/logout"><i class="fa fa-sign-out"></i> &nbsp;Logout</a>
              </li>

            </ul>
          </div>
        </nav>

        <div class="page-content">

            {% if messages %}
                {% for message in messages %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                    <div class="alert alert-danger alert-dismissible fade show">
                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                      <strong>Error!</strong>{{ message }}
                    </div>
                    {%  endif %}
                {% endfor %}

            {% endif %}

            <!-- Nav tabs -->
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#home">Users</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#menu1">Pending users</a>
              </li>

            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
              <div class="tab-pane  active " id="home">

            <table id="table_id" class="display">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Payment Status</th>
                        <th>Course</th>
                        <th>Joined On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {%  for user_obj in all_users %}
                    <tr>

                        <td><input type="checkbox" name="user_ids[]" class="user_id_checkbox" value="{{ user_obj.id }}"> {{ user_obj.id }}</td>
                        <td>{{ user_obj.first_name }} {{ user_obj.last_name }}</td>
                        <td>{{ user_obj.email }}</td>
                        <td>
                            {% if user_obj.payment_status == 'paid' %}
                            <div class="payment-status paid">Paid</div>
                            {% elif user_obj.payment_status == 'notpaid' %}
                                <div class="payment-status notpaid">Not Paid</div>
                            {% endif %}
                        </td>
                        <td>{{ user_obj.course }}</td>
                        <td>{{ user_obj.date_joined }}</td>

                        <td>
                            <button onClick="updatePaymentStatus({{ user_obj.id }})" style="min-width:50px;" class="btn mlm-btn mlm-bg-color" title="Update Payment status">
                                <i class="fa fa-dollar"></i>
                            </button>
                            <button onClick="viewTree({{ user_obj.id }})" style="min-width:50px;" class="btn mlm-btn mlm-bg-color" title="View Tree" >
                                 <i class="fa fa-eye"></i>
                            </button>
                            {% if user_obj.is_deletable %}
                            <button  onClick="deleteUser({{ user_obj.id }})" style="min-width:50px;" class="btn mlm-btn mlm-bg-color" title="Delete User" >
                                <i class="fa fa-trash-o"></i>
                            </button>
                            {%  endif %}
                        </td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>

              </div>
                 <div class="tab-pane  fade" id="menu1">

            <table id="table_pending_users" class="display">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Joined On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {%  for user_obj in pending_users %}
                    <tr>

                        <td><input type="checkbox" name="user_ids[]" class="user_id_checkbox" value="{{ user_obj.id }}"> {{ user_obj.id }}</td>
                        <td>{{ user_obj.first_name }} {{ user_obj.last_name }}</td>
                        <td>{{ user_obj.email }}</td>

                        <td>{{ user_obj.date_joined }}</td>

                        <td>
                            <button onClick="mapUser({{ user_obj.id }})" style="min-width:50px;" class="btn mlm-btn mlm-bg-color" title="Update Payment status">
                                <i class="fa fa-link"></i>
                            </button>

                            {% if user_obj.is_deletable %}
                            <button  onClick="deleteUser({{ user_obj.id }})" style="min-width:50px;" class="btn mlm-btn mlm-bg-color" title="Delete User" >
                                <i class="fa fa-trash-o"></i>
                            </button>
                            {%  endif %}
                        </td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>

                 </div>
            </div>

        </div>



                <!-- The Modal -->
        <div class="modal" id="delete_confirm_modal">
          <div class="modal-dialog">
            <div class="modal-content">
                  <form action="/remove_user" method="post">

              <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">Delete User</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">

                      {% csrf_token %}
                    <p>
                        Are you sure? The selected user will be removed permanently from the system.
                    </p>

                  <input name="deletable_user_id" type="hidden" id="deletable_user_id">


              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Delete</button>

              </div>

                  </form>


            </div>

          </div>
        </div>

        <!-- The Modal -->
        <div class="modal" id="payment_modal">
          <div class="modal-dialog">
            <div class="modal-content">
                  <form action="/update_payment_status" method="post">

              <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">Payment Status</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">

                      {% csrf_token %}
                      <div class="form-group row">
                          <div class="col-lg-4">Status <span class="required-field">*</span></div>
                          <div class="col-lg-8">
                              <select name="status" id="" class="form-control">
                                  <option value="paid">Paid</option>
                                  <option value="notpaid">Not Paid</option>
                              </select>
                          </div>
                      </div>

                  <input name="user_ids" type="hidden" id="user_ids">


              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Update</button>

              </div>

                  </form>


            </div>

          </div>
        </div>

        <input id="available_users_list" type="hidden" value="{{ available_users }}">

        <!-- The Modal -->
        <div class="modal" id="new_user_modal">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/add_user" method="post">

                <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">New user</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
                <div class="modal-body">

                      {% csrf_token %}

                     <div class="form-group row">

                        <div class="col-lg-6">
                                <input type="hidden" name="is_from_admin" value="1">
                                <input type="email" class="form-control" placeholder="Email Address" name="email"  required >
                        </div>

                         <div class="col-lg-6">
                             <select style="width: 100%" id="referer-select" class="form-control" name="referer_id">


                            </select>


                         </div>
               </div>




                    <div class="form-group row">
                    <div class="col-lg-6">

                    <input type="text" class="form-control" placeholder="First Name" name="first_name" required>
                </div>

               <div class="col-lg-6">

                    <input type="text" class="form-control" placeholder="Last Name" name="last_name" required>
                </div>

            </div>

             <div class="form-group row">
                <div class="col-lg-6">
                    <input type="password" class="form-control" placeholder="Password" name="password1" required>
                </div>
                 <div class="col-lg-6">
                    <input type="password" class="form-control" placeholder="Confirm Password" name="password2" required>
                </div>
            </div>


                </div>

                              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Submit</button>

              </div>

                  </form>

            </div>

          </div>
        </div>


           <div class="modal" id="map_user_modal">
          <div class="modal-dialog modal-md">
            <div class="modal-content">
                <form action="/map_user" method="post">

                <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">Link user</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
                <div class="modal-body">

                      {% csrf_token %}

                     <div class="form-group row">
                         <div class="col-lg-12">
                             <select style="width: 100%" id="referer-select2" class="form-control" name="referer_id">

                            </select>
                         </div>
                     </div>

                </div>

                              <!-- Modal footer -->
              <div class="modal-footer">
                  <input id="map_user_id" type="hidden" name="user_id" value="1">

                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Submit</button>

              </div>

                  </form>

            </div>

          </div>
        </div>



        <!-- The Modal -->
        <div class="modal" id="tree_view">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">User Hierarchy Tree</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
                <div class="modal-body">
                    <div id="user_treeview" >

                    </div>
                </div>
            </div>

          </div>
        </div>

        <div class="footer">

        </div>

    </div>

    <script>

        function mapUser(id){

            $("#map_user_id").val(id);
            $("#map_user_modal").modal("show");

        }

        function updatePaymentStatus(id){

            $("#user_ids").val(JSON.stringify([id]))
            $("#payment_modal").modal("show")

        }
        function deleteUser(id){
            $("#deletable_user_id").val(JSON.stringify(id))
            $("#delete_confirm_modal").modal("show")
        }

        function viewTree(id){

            $("#user_treeview").html('')

            $.ajax({url: "/get_tree/"+id, success: function(result){

                data_ha=result
                    console.debug("Tree data",data_ha)
                var chart_config = {
                            chart: {
                            container: "#user_treeview",
                            connectors: {
                                type: 'step'
                            },
                            node: {
                                HTMLclass: 'nodeExample1',
                                collapsable: true,
                            }
                        },
                        nodeStructure: data_ha[0]
                }
                    $("#tree_view").modal("show");


                    setTimeout( () => {

                                    var my_chart = new Treant(chart_config,function() {
                    var list=$(".node-desc")
                        for (var i=0;i<list.length; i++){
                            let content=list[i].textContent
                            if (content == "Not Paid"){
                                list[i].style.color="white"
                                list[i].style.backgroundColor="red"
                            }else{
                                list[i].style.color="white"
                                list[i].style.backgroundColor="green"

                            }
                        }
                    });

                    },500)

                }});

        }


        $(document).ready( function () {

            var available_udata=$("#available_users_list").val()
            $("#referer-select").select2({
                    placeholder: "Select a parent user",
                    allowClear: true,
                    data: JSON.parse(available_udata)
            });

             $("#referer-select2").select2({
                    placeholder: "Select a parent user",
                    allowClear: true,
                    data: JSON.parse(available_udata)
            });
            $('#table_pending_users').DataTable(

            );


            $('#table_id').DataTable(
                {
                        dom: "Bfrtip",
                         "aoColumnDefs": [
                            { "bSortable": false, "aTargets": [ 6 ] },
                        ],
                        buttons: [
                            {
                                text: 'Update Payment Status',
                                action: function ( e, dt, node, config ) {
                                    let checkbox_list=$(".user_id_checkbox:checkbox:checked")
                                    console.debug("Checkbox list",checkbox_list)
                                    let user_ids=[]
                                    for(let i=0;i < checkbox_list.length;i++){
                                            let check_item=checkbox_list[i]
                                            user_ids.push(check_item.value)
                                    }
                                    if(user_ids.length == 0){
                                        alert("Please select atleast one row")
                                    }else{
                                        $("#user_ids").val(JSON.stringify(user_ids))
                                        $("#payment_modal").modal("show")

                                    }


                                }
                            },
                             {
                                text: 'Add user',
                                action: function ( e, dt, node, config ) {
                                     $("#new_user_modal").modal("show")
                                }
                             }

                        ]
                    }
            );


            function readURL(input) {
              if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function(e) {
                  $('#preview_picture').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]); // convert to base64 string
              }
            }

            $("#user_picture").change(function() {
              readURL(this);
            });
        } );
    </script>

{%  endblock %}


