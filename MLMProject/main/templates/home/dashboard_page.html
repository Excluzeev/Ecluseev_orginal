{% extends 'layout.html' %}
{% load static %}
{% block content %}
    <div class="container">
    <nav class="navbar navbar-expand-md navbar-block">
          <!-- Brand -->
          <a class="navbar-brand mlm-text-color" href="#">Formula 50</a>

          <!-- Toggler/collapsibe Button -->
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"><i class="fa fa-bars"></i> </span>
          </button>

          <!-- Navbar links -->
          <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">


                    <!--
                 <li class="nav-item">
                <a data-toggle="modal" data-target="#profile_modal" class="nav-link mlm-text-color" href="#"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;My Profile</a>
              </li>
                -->
              <li class="nav-item">
                <a class="nav-link mlm-text-color" href="/logout"><i class="fa fa-sign-out"></i> &nbsp;Logout</a>
              </li>

            </ul>
          </div>
        </nav>

        <div class="page-content">


            <table id="table_id" class="display">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Payment Status</th>
                        <th>Joined On</th>
                    </tr>
                </thead>
                <tbody>
                    {%  for user_obj in all_users %}
                    <tr>

                        <td><input type="checkbox" name="user_ids[]" class="user_id_checkbox" value="{{ user_obj.id }}"> {{ user_obj.id }}</td>
                        <td>{{ user_obj.first_name }} {{ user_obj.last_name }}</td>
                        <td>{{ user_obj.email }}</td>
                        <td>
                            {% if user_obj.payment_status == 'paid' %}
                            <div class="payment-status paid">Paid</div>
                            {% elif user_obj.payment_status == 'notpaid' %}
                                <div class="payment-status notpaid">Not Paid</div>
                            {% endif %}
                        </td>
                        <td>{{ user_obj.date_joined }}</td>

                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>

        <!-- The Modal -->
        <div class="modal" id="payment_modal">
          <div class="modal-dialog">
            <div class="modal-content">
                  <form action="/update_payment_status" method="post">

              <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">Payment Status</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">

                      {% csrf_token %}
                      <div class="form-group row">
                          <div class="col-lg-4">Status <span class="required-field">*</span></div>
                          <div class="col-lg-8">
                              <select name="status" id="" class="form-control">
                                  <option value="paid">Paid</option>
                                  <option value="notpaid">Not Paid</option>
                              </select>
                          </div>
                      </div>

                  <input name="user_ids" type="hidden" id="user_ids">


              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Update</button>
              </div>
                                  </form>


            </div>

          </div>
        </div>





        <!-- The Modal -->
        <div class="modal" id="profile_modal">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/update_my_profile" method="post" enctype="multipart/form-data">

              <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">My Profile</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">

                      {% csrf_token %}
                        <div class="form-group row">
                          <div class="col-lg-4"> Name Prefix </div>
                          <div class="col-lg-8">
                              <select name="prefix" id="" class="form-control">
                                  <option value="Mr." >Mr.</option>
                                  <option value="Ms.">Ms.</option>
                                  <option value="Mrs.">Mrs.</option>

                              </select>
                          </div>
                      </div>

                      <div class="form-group row">
                          <div class="col-lg-4">Mobile </div>
                          <div class="col-lg-8">
                              <input  type="text" class="form-control" name="mobile" placeholder="Mobile number" value="{{ user_profile_obj.mobile }}">
                          </div>
                      </div>



                       <div class="form-group row">
                          <div class="col-lg-4">Picture </div>
                          <div class="col-lg-8">
                              <input id="user_picture" type="file" placeholder="Profile picture" name="picture">
                          </div>
                      </div>

                  <div class="form-group row">
                          <div class="col-lg-4"> </div>
                          <div class="col-lg-8">
                              {% if user_profile_obj.picture %}
                                  <img id="preview_picture" width="100px" src="{{  user_profile_obj.picture.url }}" alt="">
                              {%  else %}
                                  <img id="preview_picture" width="100px" src="{%  static 'img/nobody.jpg' %}" alt="default user avator">
                              {% endif %}
                          </div>
                      </div>


              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Update</button>
              </div>
                                  </form>


            </div>

          </div>
        </div>

    </div>

    <script>
        $(document).ready( function () {

            $('#table_id').DataTable(
                {
                        dom: "Bfrtip",
                         "aoColumnDefs": [
                            { "bSortable": false, "aTargets": [ 0, 1, 2, 3 ] },
                        ],
                        buttons: [
                            {
                                text: 'Update Payment Status',
                                action: function ( e, dt, node, config ) {
                                    let checkbox_list=$(".user_id_checkbox:checkbox:checked")
                                    console.debug("Checkbox list",checkbox_list)
                                    let user_ids=[]
                                    for(let i=0;i < checkbox_list.length;i++){
                                            let check_item=checkbox_list[i]
                                            user_ids.push(check_item.value)
                                    }
                                    if(user_ids.length == 0){
                                        alert("Please select atleast one row")
                                    }else{
                                        $("#user_ids").val(JSON.stringify(user_ids))
                                        $("#payment_modal").modal("show")
                                    }


                                }
                            },

                        ]
                    }
            );


            function readURL(input) {
              if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function(e) {
                  $('#preview_picture').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]); // convert to base64 string
              }
            }

            $("#user_picture").change(function() {
              readURL(this);
            });
        } );
    </script>

{%  endblock %}


