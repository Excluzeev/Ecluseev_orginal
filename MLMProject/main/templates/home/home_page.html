{% extends 'layout.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid">
    <nav class="navbar navbar-expand-md navbar-block">
          <!-- Brand -->
          <a class="navbar-brand mlm-text-color" href="#">Formula 50</a>

          <!-- Toggler/collapsibe Button -->
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"><i class="fa fa-bars"></i> </span>
          </button>

          <!-- Navbar links -->
          <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">
                <!--
              <li class="nav-item">
                <a class="nav-link mlm-text-color active-link" href="/home"><i class="fa fa-home"></i> &nbsp;Home</a>
              </li>
              -->

                 <li class="nav-item">
                <a data-toggle="modal" data-target="#profile_modal" class="nav-link mlm-text-color" href="#"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;My Profile</a>
              </li>
              <li class="nav-item">
                <a class="nav-link mlm-text-color" href="/logout"><i class="fa fa-sign-out"></i> &nbsp;Logout</a>
              </li>

            </ul>
          </div>
        </nav>

        <div class="page-content-home">
          {% if messages %}
                {% for message in messages %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                    <div class="alert alert-danger alert-dismissible fade show">
                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                      <strong>Error!</strong>{{ message }}
                    </div>
                    {%  endif %}
                {% endfor %}

            {% endif %}
            <div class="statistics-block">
                <div class="stat-item">Course <span>{{ user_profile_obj.course }}</span></div>
                <div class="stat-item">Group <span>{{ user_group_id }}</span></div>
                <div class="stat-item">Role <span>{{ user_profile_obj.designation }}</span></div>
                <div class="stat-item">Payment Status
                    {% if user_profile_obj.payment_status == "paid" %}
                        <span class="text-success">Paid</span>
                        {%  else %}
                        <span class="text-danger">Not Paid</span>
                    {%  endif %}
                </div>



            </div>

            <table id="table_id" class="display">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Invite On</th>
                    </tr>
                </thead>
                <tbody>
                    {%  for invite_obj in invites %}
                    <tr>
                        <td>{{ invite_obj.id }}</td>
                        <td>{{ invite_obj.email }}</td>
                        <td>
                            {% if invite_obj.status == 'invited' %}
                            <div class="invite-status invited">Invited</div>
                            {% elif invite_obj.status == 'accepted' %}
                                <div class="invite-status accepted">Accepted</div>
                            {% endif %}
                        </td>
                        <td>{{ invite_obj.created_on }}</td>

                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>

        <div class="treeview-container">

            <div id="treeview" >

            </div>

        </div>


        <!-- The Modal -->
        <div class="modal" id="invite_modal">
          <div class="modal-dialog">
            <div class="modal-content">
                  <form action="/invite" method="post">

              <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">Invite</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">

                      {% csrf_token %}
                      <div class="form-group row">
                          <div class="col-lg-4">Email <span class="required-field">*</span></div>
                          <div class="col-lg-8">
                              <input required type="email" class="form-control" name="email" placeholder="Email Address">
                          </div>
                      </div>

                       <div class="form-group row">
                          <div class="col-lg-4">Message <span class="required-field">*</span></div>
                          <div class="col-lg-8">
                              <textarea required class="form-control" name="message" id="" cols="30" rows="3"></textarea>
                          </div>
                      </div>


              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Send Invite</button>
              </div>
                                  </form>


            </div>

          </div>
        </div>


                    <!-- The Modal -->
        <div class="modal" id="profile_modal">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/update_my_profile" method="post" enctype="multipart/form-data">

              <!-- Modal Header -->
              <div class="modal-header">
                <h4 class="modal-title">My Profile</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>

              <!-- Modal body -->
              <div class="modal-body">

                      {% csrf_token %}

                        <div class="form-group row">
                          <div class="col-lg-4">Email </div>
                          <div class="col-lg-8">
                              <input readonly  type="text" class="form-control" value="{{ user_profile_obj.auth_user.email }}">
                          </div>
                      </div>
                        <div class="form-group row">
                          <div class="col-lg-4"> Name Prefix </div>
                          <div class="col-lg-8">
                              <select name="prefix" id="" class="form-control">
                                  <option value="Mr." >Mr.</option>
                                  <option value="Ms.">Ms.</option>
                                  <option value="Mrs.">Mrs.</option>

                              </select>
                          </div>
                      </div>

                      <div class="form-group row">
                          <div class="col-lg-4">Mobile </div>
                          <div class="col-lg-8">
                              <input  type="text" class="form-control" name="mobile" placeholder="Mobile number" value="{{ user_profile_obj.mobile }}">
                          </div>
                      </div>



                       <div class="form-group row">
                          <div class="col-lg-4">Picture </div>
                          <div class="col-lg-8">
                              <input id="user_picture" type="file" placeholder="Profile picture" name="picture">
                          </div>
                      </div>

                  <div class="form-group row">
                          <div class="col-lg-4"> </div>
                          <div class="col-lg-8">
                              {% if user_profile_obj.picture %}
                                  <img id="preview_picture" width="100px" src="{{  user_profile_obj.picture.url }}" alt="">
                              {%  else %}
                                  <img id="preview_picture" width="100px" src="{%  static 'img/nobody.jpg' %}" alt="default user avator">
                              {% endif %}
                          </div>
                      </div>


              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
                  <button type="button" class="btn mlm-btn mlm-bg-color" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn mlm-btn mlm-bg-color" >Update</button>
              </div>
                                  </form>


            </div>

          </div>
        </div>

        <input id="ha_data" type="hidden" value="{{ user_hierarchy }}">

        <div class="footer">

        </div>

    </div>

    <script>
        $(document).ready( function () {

            $('#table_id').DataTable(
                {
                        dom: "Bfrtip",
                        buttons: [
                            {
                                text: 'Invite',
                                action: function ( e, dt, node, config ) {

                                    $("#invite_modal").modal("show")

                                }
                            },

                        ]
                    }
            );
            var data_ha = $("#ha_data").val()
            console.debug("Data Ha",data_ha)
            data_ha=JSON.parse(data_ha)

            var chart_config = {
                    chart: {
                    container: "#treeview",
                    connectors: {
                        type: 'step'
                    },
                    node: {
                        HTMLclass: 'nodeExample1',
                        collapsable: true,
                    },
                },
                nodeStructure: data_ha[0]
        }

            var my_chart = new Treant(chart_config,function() {
                    var list=$(".node-desc")
                        for (var i=0;i<list.length; i++){
                            let content=list[i].textContent
                            if (content == "Not Paid"){
                                list[i].style.color="white"
                                list[i].style.backgroundColor="red"
                            }else{
                                list[i].style.color="white"
                                list[i].style.backgroundColor="green"

                            }
                        }
                    }
            );


            function readURL(input) {
              if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function(e) {
                  $('#preview_picture').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]); // convert to base64 string
              }
            }

            $("#user_picture").change(function() {
              readURL(this);
            });
        } );
    </script>

{%  endblock %}


